<!DOCTYPE html>
<html>
    <head>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
        <script src="js/jQuery/jquery-1.11.1.js"></script>
        <script src="highstocks/highstock.js"></script>
        <script src="highstocks/exporting.js"></script>
        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0px; padding: 0px }
            #wrapper { position: relative; }
            #googleMap { height: 100% }
            #chartContainer { height: 300px; width: auto; display: none ;z-index: 3;position: absolute;top: 10px;left: 10px;}
            #control_panel {height: auto; width: auto; z-index: 3; position: absolute; top: 20px; right: 20px;}
        </style>
        <script>
            function getParameterByName(name) {
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                        results = regex.exec(location.search);
                return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            }
            function initialize() {
                imei = '12345678901234';
                fromDate = getParameterByName('from_date');
                toDate = getParameterByName('to_date');
                samplingRate = getParameterByName('sampling_rate');
                $('#from_date').val(fromDate);
                $('#to_date').val(toDate);
                $('#sampling_rate').val(samplingRate);
                downloadKmzLayerProcessor = 'downloadKmzLayer.php';
                downloadAllLocationsProcessor = 'downloadLocations.php';
                downloadAdminRegionStatisticsProcessor = 'downloadAdminRegionStatistics.php';
                downloadLatestLocationStatisticsProcessor = 'downloadLatestLocationStatistics.php';
                downloadOverallLocationStatisticsProcessor = 'downloadOverallLocationStatistics.php';
                var mapOptions = {
                    //give latitude and long
                    center: new google.maps.LatLng(7.0, 81.0),
                    zoom: 7,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                infoWindow = new google.maps.InfoWindow();
                map = new google.maps.Map(document.getElementById("googleMap"), mapOptions);
                timeStamp = Math.round(new Date().getTime() / 1000);
                $.getJSON(downloadKmzLayerProcessor, {
                    imei: imei,
                    from_date: fromDate,
                    to_date: toDate,
                    sampling_rate: samplingRate,
                    time_stamp: timeStamp
                }).success(function (data) {
                    kmzLayer = new google.maps.KmlLayer('http://156.56.93.34/CDME/kml/SL/admin_2_regions_' + imei + '_' + timeStamp + '.kmz');
                    kmzLayer.setMap(null);
                    kmzLayer.setMap(map);
                    google.maps.event.addListener(kmzLayer, 'click', function (kmlEvent) {
                        var arr = kmlEvent.featureData.id.trim().split('_');
                        var regionName = kmlEvent.featureData.name.trim();
                        var id = arr[0];
                        var level = arr[1];
                        showDistrictStatisticsGraph(id, level, regionName, fromDate, toDate, samplingRate, downloadAdminRegionStatisticsProcessor);
                    });
                });

                showAllLocationPoints(downloadAllLocationsProcessor);
                google.maps.event.addListener(infoWindow, 'closeclick', function () {
                    console.log("ji");
                });
            }

            function showDistrictStatisticsGraph(id, level, regionName, fromDate, toDate, samplingRate, processorPath) {
                var meanDataPointsArray = [];
                var medianDataPointsArray = [];
                var modDataPointsArray = [];
                var sdDataPointsArray = [];
                $.getJSON(processorPath, {
                    region_id: id,
                    region_level: level,
                    from_date: fromDate,
                    to_date: toDate,
                    sampling_rate: samplingRate
                }).success(function (data) {
                    $.each(data, function (i, item) {
                        meanDataPointsArray.push([item.date_time * 1000, parseFloat(item.mean || 0)]);
                        medianDataPointsArray.push([item.date_time * 1000, parseFloat(item.median || 0)]);
                        modDataPointsArray.push([item.date_time * 1000, parseFloat(item.mod || 0)]);
                        sdDataPointsArray.push([item.date_time * 1000, parseFloat(item.sd || 0)]);
                    });
                    $('#chartContainer').highcharts('StockChart', {
                        legend: {
                            enabled: true,
                            align: 'bottom'
                        },
                        rangeSelector: {
                            selected: 1
                        },
                        title: {
                            text: regionName + ' Region Statistics'
                        },
                        series: [{
                                name: 'Mean',
                                data: meanDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Median',
                                data: medianDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Mod',
                                data: modDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Stand. Deviation',
                                data: sdDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            }]
                    });
                    $('#chartContainer').show("slow");
                });
            }

            function setInfoWindowContent(marker) {
                $.getJSON(downloadLatestLocationStatisticsProcessor, {
                    locationId: marker.locationId,
                    from_date: fromDate,
                    to_date: toDate,
                }).success(function (data) {
                    var mean = 0;
                    var median = 0;
                    var mod = 0;
                    var sd = 0;
                    if (data != null) {
                        mean = data[0].mean;
                        median = data[0].median;
                        mod = data[0].mod;
                        sd = data[0].sd;
                    }
                    infoWindow.setContent("<table style=\"width:100%\"><tr><td>Mean</td><td>" + mean + "</td></tr><tr><td>Median</td><td>" + median + "</td></tr><tr><td>Mod</td><td>" + mod + "</td></tr><tr><td>Standard Deviation</td><td>" + sd + "</td></tr></table>");
                    infoWindow.open(map, marker);
                });
            }

            function setOverallStatisticsGraph(marker) {
                var meanDataPointsArray = [];
                var medianDataPointsArray = [];
                var modDataPointsArray = [];
                var sdDataPointsArray = [];
                $.getJSON(downloadOverallLocationStatisticsProcessor, {
                    locationId: marker.locationId,
                }).success(function (data) {
                    $.each(data, function (i, item) {
                        meanDataPointsArray.push([item.date_time * 1000, parseFloat(item.mean || 0)]);
                        medianDataPointsArray.push([item.date_time * 1000, parseFloat(item.median || 0)]);
                        modDataPointsArray.push([item.date_time * 1000, parseFloat(item.mod || 0)]);
                        sdDataPointsArray.push([item.date_time * 1000, parseFloat(item.sd || 0)]);
                    });
                    $('#chartContainer').highcharts('StockChart', {
                        legend: {
                            enabled: true,
                            align: 'bottom'
                        },
                        rangeSelector: {
                            selected: 1
                        },
                        title: {
                            text: 'Location Point Statistics'
                        },
                        series: [{
                                name: 'Mean',
                                data: meanDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Median',
                                data: medianDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Mod',
                                data: modDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            },
                            {
                                name: 'Stand. Deviation',
                                data: sdDataPointsArray,
                                tooltip: {
                                    valueDecimals: 2
                                }
                            }]
                    });
                    $('#chartContainer').show("slow");
                });
            }

            function showAllLocationPoints(processorPath) {
                $.getJSON(processorPath, {
                    from_date: fromDate,
                    to_date: toDate
                }).success(function (data) {
                    $.each(data, function (i, item) {
                        //give latitude and long
                        var myLatlng = new google.maps.LatLng(item.latitude, item.longitude);
                        var marker = new google.maps.Marker({
                            position: myLatlng,
                            map: map,
                            title: item.noise_level,
                            locationId: item.location_id
                        });
                        google.maps.event.addListener(marker, 'click', function () {
                            setInfoWindowContent(marker);
                            setOverallStatisticsGraph(marker);
                        });
                    });
                });
            }

            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>

    <body>
        <div id="googleMap"></div>
        <div id="chartContainer"></div>
        <div id="control_panel">
            <form>
                From:<br>
                <input id="from_date" type="text" name="from_date">
                <br>
                To:<br>
                <input id="to_date" type="text" name="to_date">
                <br>
                Sampling Rate:<br>
                <input id="sampling_rate" type="text" name="sampling_rate">
                <br><br>
                <input type="submit" value="Render">
            </form>
        </div>
    </body>
</html>